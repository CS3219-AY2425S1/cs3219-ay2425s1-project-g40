# Question Service

## Quick start (for testers)

### Pre-requisites

1. Python 3.12
2. Docker (for local MongDB server)

### Running the server

**Before you begin**

From the project root,

```bash
cd backend/question-service
```

1. Create Python virual environment

```bash
python3 -m venv env
```

2. Activate the virtual environment

```bash
source env/bin/activate or ./env/Scripts/activate
```

3. Install dependencies

```bash
pip install -r requirements.txt
```

4. Start local MongoDB server

```bash
make db
```

5. Start question-service backend

```bash
uvicorn question_service.main:app --reload
```

---

## Quick start (for developers)

### Pre-requisites

1. Python 3.12
2. [`pipx`](https://pipx.pypa.io/stable/installation/)
   - From Python3, you cannot `pip install` Python programs globally
3. [Poetry](https://python-poetry.org/docs/#installing-with-pipx) -- _dependency management for Python_
   - `pipx install poetry`
4. Docker (for local MongoDB server)

---

## Quick start

> MongoDB is run locally as a Docker container -- Atlas may be used for production

1. Create a virtual environment

```bash
# install dependencies
poetry install
```

2. Create a local database

```bash
make db
```

<details>
    <summary>Without <code>make</code></summary>

    ```bash
    docker run --name question-db -p 27017:27017 -d \
    	-e MONGO_INITDB_ROOT_USERNAME=mongoadmin \
    	-e MONGO_INITDB_ROOT_PASSWORD=secret \
    	-e MONGO_INITDB_DATABASE=questions_db \
    	-e INIT_QUESTION_COLLECTION=questions \
    	alxarkar/cs3219-ay2425s1-g40-question

    ```

</details>

3. Run the server

```bash
make server
```

<details>
    <summary>Without <code>make</code></summary>

    ```bash
    poetry run uvicorn question_service.main:app --reload
    ```

</details>

---

### Exporting `requirements.txt`

```bash
poetry export -o requirements.txt
```

### Adding packages

```bash
poetry add <package name>@version
poetry add -D <package name>@version

poetry remove <package name>
poetry remove -D <package name>
```

### Lint and format

```bash
make lint
make format
```

### Test

```
make test
```

## Question Service API Guide

### Create Question

- This endpoint allows adding a new question to the database

- HTTP Method: `POST`

- Endpoint: http://localhost:3001/question

- Body
  - Required: `title` (string), `description` (string), `difficulty` (string/Enum), `topic` (string)

    ```json
    {
      "title": "SampleQuestion",
      "description": "SampleQuestionDescription",
      "difficulty": "Easy/Medium/Hard",
      "topic": "dynamic programming"
    }
    ```

- Responses:

    | Response Code               | Explanation                                                   |
    |-----------------------------|---------------------------------------------------------------|
    | 201 (Created)               | Question created successfully, created question data returned |
    | 400 (Bad Request)           | Missing fields                                                |
    | 409 (Conflict)              | Duplicate title encountered                                   |
    | 500 (Internal Server Error) | Database or server error                                      |

### Get Question

- This endpoint allows retrieval of a single question from the database using the question ID.

  > :bulb: The question ID refers to the MongoDB Object titleSlug, a unique identifier automatically generated by MongoDB for each question.

- HTTP Method: `GET`

- Endpoint: http://localhost:3001/question/{titleSlug}

- Parameters
    - Required: `titleSlug` path parameter
    - Example: `http://localhost:3001/question/reverse-string`

   
- Responses:

    | Response Code               | Explanation                                     |
    |-----------------------------|-------------------------------------------------|
    | 200 (OK)                    | Success, question returned                      |
    | 404 (Not Found)             | Question with the specified titleSlug not found |
    | 500 (Internal Server Error) | Database or server error                        |

### Get All Questions

- This endpoint allows retrieval of all questions from the database.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/question

- Responses:

    | Response Code               | Explanation                                      |
    |-----------------------------|--------------------------------------------------|
    | 200 (OK)                    | Success, all questions returned                  |
    | 404 (Error)                 | No questions in database                         |
    | 500 (Internal Server Error) | Database or server error                         |

### Update Question

- This endpoint allows updating a question and their related data in the database using the question's titleSlug.

- HTTP Method: `PATCH`

- Endpoint: http://localhost:3001/users/{titleSlug}

- Parameters
  - Required: `titleSlug` path parameter

- Body
  - At least one of the following fields is required: `title` (string), `description` (string), `difficulty` (string/Enum), `topic` (string)

    ```json
     {
      "title": "SampleQuestion",
      "description": "SampleQuestionDescription",
      "difficulty": "Easy/Medium/Hard",
      "topic": "dynamic programming"
    }
    ```

- Responses:

    | Response Code               | Explanation                                           |
    |-----------------------------|-------------------------------------------------------|
    | 200 (OK)                    | Question updated successfully, updated question data returned |
    | 400 (Bad Request)           | Missing fields                                        |
    | 403 (Forbidden)             | Access denied for non-admin users updating questions  |
    | 404 (Not Found)             | Question with the specified ID not found              |
    | 409 (Conflict)              | Duplicate title  encountered                          |
    | 500 (Internal Server Error) | Database or server error                              |

### Delete Question

- This endpoint allows deletion of a question and their related data from the database using the question's titleSlug.
- HTTP Method: `DELETE`
- Endpoint: http://localhost:3001/question/{titleSlug}
- Parameters

  - Required: `titleSlug` path parameter
- Headers

  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`

  - Auth Rules:

    - Admin users: Can delete any question. The server verifies the user associated with the JWT token is an admin user and allows the deletion of requested user's data.

- Responses:

    | Response Code               | Explanation                                          |
    |-----------------------------|------------------------------------------------------|
    | 200 (OK)                    | Question deleted successfully                        |
    | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT     |
    | 403 (Forbidden)             | Access denied for non-admin users deleting questions |
    | 404 (Not Found)             | Question with the specified titleSlug not found      |
    | 500 (Internal Server Error) | Database or server error                             |
